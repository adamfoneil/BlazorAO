@page "/Setup/PayPeriods"
@inject DapperCX<int, UserProfile> Data
@attribute [Authorize]

<h3>Pay Periods</h3>
<p>Pay Periods are created automatically except for the first one.</p>

<ErrorMessage @ref="error"/>

<div class="mb-2 d-flex align-items-center">
    <RadzenButton Text="Add" Icon="add_circle_outline" Click="InsertRow"/>
</div>

<RadzenGrid TItem="PayPeriodsResult" Data="data" RowCreate="SaveRow" RowUpdate="SaveRow" @ref="grid">
	<Columns>

        <RadzenGridColumn TItem="PayPeriodsResult" Title="Start Date" Property="StartDate">
            <Template Context="pp">
                <span>@pp.StartDate.ToString("ddd M/d/yy")</span>
            </Template>
        </RadzenGridColumn>

		<RadzenGridColumn TItem="PayPeriodsResult" Title="End Date" Property="EndDate">
            <Template Context="pp">
                <span>@pp.EndDate.ToString("ddd M/d/yy")</span>
            </Template>
			<EditTemplate Context="pp">
				<RadzenDatePicker @bind-Value="pp.EndDate" DateFormat="ddd M/d/yy"/>
			</EditTemplate>
		</RadzenGridColumn>

        <GridControls Grid="grid" DeleteRow="DeleteRow" TItem="PayPeriodsResult"/>

	</Columns>
</RadzenGrid>

<div class="mt-2">
    <p>As long as one Pay Period exists, there's no need to create additional Pay Periods manually. You can if you like, however.</p>
    <RadzenButton Text="Add Next" Icon="add_circle_outline" Click="AddNextPeriod"/>
</div>


<GitHubLink/>

@code {
    ErrorMessage error;
    IEnumerable<PayPeriodsResult> data;
    RadzenGrid<PayPeriodsResult> grid;
    BlazorAO.Models.Workspace workspace;

    protected override async Task OnInitializedAsync()
    {
        workspace = await Data.GetAsync<BlazorAO.Models.Workspace>(Data.User?.WorkspaceId ?? 0);

        await RefreshList();
    }

    async Task RefreshList()
    {
        data = await Data.QueryAsync(new Queries.PayPeriods()
        {
            WorkspaceId = Data.User?.WorkspaceId ?? 0
        });
    }

    async Task SaveRow(PayPeriodsResult payPeriod)
    {
        var saveRow = payPeriod.CopyAs<PayPeriod>();
        await Data.TrySaveAsync(saveRow,
            onSuccess: async (id) => await RefreshList(),
            onException: (exc) => error.Message = exc.Message);
    }

    async Task DeleteRow(PayPeriodsResult row) =>
        await Data.TryDeleteAsync<PayPeriod>(row.Id,
            onSuccess: async () => await RefreshList(),
            onException: (exc) => error.Message = exc.Message);

    void InsertRow() => grid.InsertRow(new PayPeriodsResult()
    {
        WorkspaceId = Data.User?.WorkspaceId ?? 0,
        // sql server week days are +1 .NET week days
        EndDate = DateTime.Today.FirstAfter((DayOfWeek)workspace.PayPeriodEndDay - 1)
    });

    async Task AddNextPeriod()
    {

    }
}
